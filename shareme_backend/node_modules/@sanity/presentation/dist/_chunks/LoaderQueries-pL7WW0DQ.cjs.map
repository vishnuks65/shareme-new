{"version":3,"file":"LoaderQueries-pL7WW0DQ.cjs","sources":["../../../visual-editing-helpers/dist/hooks.js","../../src/loader/LoaderQueries.tsx"],"sourcesContent":["import{useMemo as e,useState as n,useCallback as t,useEffect as i,useSyncExternalStore as r}from\"react\";function o(n){const t=e((()=>JSON.stringify(n||{})),[n]);return e((()=>JSON.parse(t)),[t])}function s(e){const{refreshInterval:o}=e,s=function(){const[e,t]=n(!1);i((()=>{t(navigator.onLine);const e=()=>t(!0),n=()=>t(!1);return window.addEventListener(\"online\",e),window.addEventListener(\"offline\",n),()=>{window.removeEventListener(\"online\",e),window.removeEventListener(\"offline\",n)}}),[]);const o=r(u,(()=>document.visibilityState),(()=>\"hidden\"));if(!e)return!0;if(\"hidden\"===o)return!0;return!1}(),[d,c]=n(\"hit\"),f=t((()=>(c(\"inflight\"),()=>c(\"hit\"))),[]);return i((()=>{if(!o||\"hit\"!==d)return;const e=setTimeout((()=>c(\"stale\")),o);return()=>clearTimeout(e)}),[o,d]),i((()=>{if(\"hit\"!==d)return;const e=()=>c(\"stale\");return window.addEventListener(\"focus\",e),()=>window.removeEventListener(\"focus\",e)}),[o,d]),i((()=>{s&&\"hit\"===d&&c(\"stale\"),s||\"stale\"!==d||c(\"refresh\")}),[s,d]),[d,f]}function u(e){return document.addEventListener(\"visibilitychange\",e),()=>document.removeEventListener(\"visibilitychange\",e)}export{o as useQueryParams,s as useRevalidate};//# sourceMappingURL=hooks.js.map\n","import type { ChannelsController } from '@sanity/channels'\nimport type {\n  ClientConfig,\n  ClientPerspective,\n  ContentSourceMap,\n  QueryParams,\n} from '@sanity/client'\nimport { applySourceDocuments, getPublishedId } from '@sanity/client/csm'\nimport type {\n  LoaderPayloads,\n  VisualEditingMsg,\n} from '@sanity/visual-editing-helpers'\nimport {\n  useQueryParams,\n  useRevalidate,\n} from '@sanity/visual-editing-helpers/hooks'\nimport { applyPatch } from 'mendoza'\nimport LRUCache from 'mnemonist/lru-cache-with-delete'\nimport { memo, useEffect, useMemo, useState } from 'react'\nimport { type SanityClient, type SanityDocument, useClient } from 'sanity'\n\nimport {\n  LIVE_QUERY_CACHE_BATCH_SIZE,\n  LIVE_QUERY_CACHE_SIZE,\n} from '../constants'\nimport type { LiveQueriesState } from '../types'\n\nexport interface LoaderQueriesProps {\n  liveDocument: Partial<SanityDocument> | null | undefined\n  channel: ChannelsController<VisualEditingMsg> | undefined\n  perspective: ClientPerspective\n  liveQueries: LiveQueriesState\n  documentsOnPage: { _id: string; _type: string }[]\n}\n\nexport default function LoaderQueries(props: LoaderQueriesProps): JSX.Element {\n  const {\n    liveDocument,\n    channel,\n    perspective: activePerspective,\n    liveQueries,\n    documentsOnPage,\n  } = props\n  const [cache] = useState(\n    () => new LRUCache<string, SanityDocument>(LIVE_QUERY_CACHE_SIZE),\n  )\n  const studioClient = useClient({ apiVersion: '2023-10-16' })\n  const clientConfig = useMemo(() => studioClient.config(), [studioClient])\n  const client = useMemo(\n    () =>\n      studioClient.withConfig({\n        resultSourceMap: 'withKeyArraySelector',\n      }),\n    [studioClient],\n  )\n  useEffect(() => {\n    if (channel) {\n      const { projectId, dataset } = clientConfig\n      channel.send('loaders', 'loader/perspective', {\n        projectId: projectId!,\n        dataset: dataset!,\n        perspective: activePerspective,\n      } satisfies LoaderPayloads['perspective'])\n    }\n  }, [channel, clientConfig, activePerspective])\n\n  const turboIds = useMemo(() => {\n    const documentsActuallyInUse = documentsOnPage.map(({ _id }) => _id)\n    const set = new Set(documentsActuallyInUse)\n    const ids = [...set]\n    const max = cache.capacity\n    if (ids.length >= max) {\n      ids.length = max\n    }\n    return ids\n  }, [cache.capacity, documentsOnPage])\n\n  const [documentsCacheLastUpdated, setDocumentsCacheLastUpdated] = useState(0)\n\n  return (\n    <>\n      <Turbo\n        cache={cache}\n        client={client}\n        turboIds={turboIds}\n        setDocumentsCacheLastUpdated={setDocumentsCacheLastUpdated}\n      />\n      {Object.entries(liveQueries).map(\n        ([key, { query, params, perspective }]) => (\n          <QuerySubscription\n            key={`${key}${perspective}`}\n            cache={cache}\n            projectId={clientConfig.projectId!}\n            dataset={clientConfig.dataset!}\n            perspective={perspective}\n            query={query}\n            params={params}\n            channel={channel}\n            client={client}\n            refreshInterval={activePerspective ? 2000 : 0}\n            liveDocument={liveDocument}\n            documentsCacheLastUpdated={documentsCacheLastUpdated}\n          />\n        ),\n      )}\n    </>\n  )\n}\n\ninterface SharedProps {\n  /**\n   * The Sanity client to use for fetching data and listening to mutations.\n   */\n  client: SanityClient\n  /**\n   * How frequently queries should be refetched in the background to refresh the parts of queries that can't be source mapped.\n   * Setting it to `0` will disable background refresh.\n   * @defaultValue 10000\n   */\n  refreshInterval?: number\n  /**\n   * The documents cache to use for turbo-charging queries.\n   */\n  cache: LRUCache<string, SanityDocument>\n}\n\ninterface TurboProps extends Pick<SharedProps, 'client' | 'cache'> {\n  turboIds: string[]\n  setDocumentsCacheLastUpdated: (timestamp: number) => void\n}\n/**\n * A turbo-charged mutation observer that uses Content Source Maps to apply mendoza patches on your queries\n */\nconst Turbo = memo(function Turbo(props: TurboProps) {\n  const { cache, client, turboIds, setDocumentsCacheLastUpdated } = props\n  // Figure out which documents are missing from the cache\n  const [batch, setBatch] = useState<string[][]>([])\n  useEffect(() => {\n    const batchSet = new Set(batch.flat())\n    const nextBatch = new Set<string>()\n    for (const turboId of turboIds) {\n      if (!batchSet.has(turboId) && !cache.has(turboId)) {\n        nextBatch.add(turboId)\n      }\n    }\n    const nextBatchSlice = [...nextBatch].slice(0, LIVE_QUERY_CACHE_BATCH_SIZE)\n    if (nextBatchSlice.length === 0) return\n    setBatch((prevBatch) => [\n      ...prevBatch.slice(-LIVE_QUERY_CACHE_BATCH_SIZE),\n      nextBatchSlice,\n    ])\n  }, [batch, cache, turboIds])\n\n  // Use the same listen instance and patch documents as they come in\n  useEffect(() => {\n    const subscription = client\n      .listen(\n        '*',\n        {},\n        {\n          events: ['mutation'],\n          effectFormat: 'mendoza',\n          includePreviousRevision: false,\n          includeResult: false,\n          tag: 'presentation-loader',\n        },\n      )\n      .subscribe((update) => {\n        if (update.type === 'mutation' && update.transition === 'disappear') {\n          if (cache.delete(update.documentId)) {\n            setDocumentsCacheLastUpdated(Date.now())\n          }\n        }\n\n        if (update.type !== 'mutation' || !update.effects?.apply?.length) return\n        // Schedule a reach state update with the ID of the document that were mutated\n        // This react handler will apply the document to related source map snapshots\n        const cachedDocument = cache.peek(update.documentId)\n        if (cachedDocument as SanityDocument) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          const patchDoc = { ...cachedDocument } as any\n          delete patchDoc._rev\n          const patchedDocument = applyPatch(patchDoc, update.effects.apply)\n          cache.set(update.documentId, patchedDocument)\n          setDocumentsCacheLastUpdated(Date.now())\n        }\n      })\n    return () => subscription.unsubscribe()\n  }, [cache, client, setDocumentsCacheLastUpdated])\n\n  return (\n    <>\n      {batch.map((ids) => (\n        <GetDocuments\n          key={JSON.stringify(ids)}\n          cache={cache}\n          client={client}\n          ids={ids}\n          setDocumentsCacheLastUpdated={setDocumentsCacheLastUpdated}\n        />\n      ))}\n    </>\n  )\n})\n\ninterface GetDocumentsProps extends Pick<SharedProps, 'client' | 'cache'> {\n  ids: string[]\n  setDocumentsCacheLastUpdated: (timestamp: number) => void\n}\nconst GetDocuments = memo(function GetDocuments(props: GetDocumentsProps) {\n  const { client, cache, ids, setDocumentsCacheLastUpdated } = props\n\n  useEffect(() => {\n    const missingIds = ids.filter((id) => !cache.has(id))\n    if (missingIds.length === 0) return\n    client.getDocuments(missingIds).then((documents) => {\n      for (const doc of documents) {\n        if (doc && doc?._id) {\n          cache.set(doc._id, doc)\n          setDocumentsCacheLastUpdated(Date.now())\n        }\n      }\n      // eslint-disable-next-line no-console\n    }, console.error)\n  }, [cache, client, ids, setDocumentsCacheLastUpdated])\n\n  return null\n})\nGetDocuments.displayName = 'GetDocuments'\n\ninterface QuerySubscriptionProps\n  extends Pick<\n    UseQuerySubscriptionProps,\n    | 'client'\n    | 'cache'\n    | 'refreshInterval'\n    | 'liveDocument'\n    | 'documentsCacheLastUpdated'\n  > {\n  projectId: string\n  dataset: string\n  perspective: ClientPerspective\n  query: string\n  params: QueryParams\n  channel: ChannelsController<VisualEditingMsg> | undefined\n}\nfunction QuerySubscription(props: QuerySubscriptionProps) {\n  const {\n    cache,\n    projectId,\n    dataset,\n    perspective,\n    query,\n    client,\n    refreshInterval,\n    liveDocument,\n    channel,\n    documentsCacheLastUpdated,\n  } = props\n\n  const params = useQueryParams(props.params)\n  const data = useQuerySubscription({\n    cache,\n    client,\n    liveDocument,\n    params,\n    perspective,\n    query,\n    refreshInterval,\n    documentsCacheLastUpdated,\n  })\n  const result = data?.result\n  const resultSourceMap = data?.resultSourceMap\n\n  useEffect(() => {\n    if (resultSourceMap) {\n      channel!.send('loaders', 'loader/query-change', {\n        projectId,\n        dataset,\n        perspective,\n        query,\n        params,\n        result,\n        resultSourceMap,\n      } satisfies LoaderPayloads['query-change'])\n    }\n  }, [\n    channel,\n    dataset,\n    params,\n    perspective,\n    projectId,\n    query,\n    result,\n    resultSourceMap,\n  ])\n\n  return null\n}\n\ninterface UseQuerySubscriptionProps\n  extends Required<Pick<SharedProps, 'client' | 'refreshInterval' | 'cache'>> {\n  liveDocument: Partial<SanityDocument> | null | undefined\n  query: string\n  params: QueryParams\n  perspective: ClientPerspective\n  documentsCacheLastUpdated: number\n}\nfunction useQuerySubscription(props: UseQuerySubscriptionProps) {\n  const {\n    cache,\n    liveDocument,\n    client,\n    refreshInterval,\n    query,\n    params,\n    perspective,\n    documentsCacheLastUpdated,\n  } = props\n  const [snapshot, setSnapshot] = useState<{\n    result: unknown\n    resultSourceMap?: ContentSourceMap\n  } | null>(null)\n  const { projectId, dataset } = useMemo(() => {\n    const { projectId, dataset } = client.config()\n    return { projectId, dataset } as Required<\n      Pick<ClientConfig, 'projectId' | 'dataset'>\n    >\n  }, [client])\n\n  // Make sure any async errors bubble up to the nearest error boundary\n  const [error, setError] = useState<unknown>(null)\n  if (error) throw error\n\n  const [revalidate, startRefresh] = useRevalidate({ refreshInterval })\n  const shouldRefetch = revalidate === 'refresh' || revalidate === 'inflight'\n  useEffect(() => {\n    if (!shouldRefetch) {\n      return\n    }\n\n    let fulfilled = false\n    let fetching = false\n    const controller = new AbortController()\n    // eslint-disable-next-line no-inner-declarations\n    async function effect() {\n      const { signal } = controller\n      fetching = true\n      const { result, resultSourceMap } = await client.fetch(query, params, {\n        tag: 'presentation-loader',\n        signal,\n        perspective,\n        filterResponse: false,\n      })\n      fetching = false\n\n      if (!signal.aborted) {\n        setSnapshot({ result, resultSourceMap })\n\n        fulfilled = true\n      }\n    }\n    const onFinally = startRefresh()\n    effect()\n      .catch((error) => {\n        fetching = false\n        if (error.name !== 'AbortError') {\n          setError(error)\n        }\n      })\n      .finally(onFinally)\n    return () => {\n      if (!fulfilled && !fetching) {\n        controller.abort()\n      }\n    }\n  }, [\n    client,\n    dataset,\n    liveDocument,\n    params,\n    perspective,\n    projectId,\n    query,\n    shouldRefetch,\n    startRefresh,\n  ])\n\n  return useMemo(() => {\n    if (documentsCacheLastUpdated && snapshot?.resultSourceMap) {\n      return {\n        result: turboChargeResultIfSourceMap(\n          cache,\n          liveDocument,\n          snapshot.result,\n          perspective,\n          snapshot.resultSourceMap,\n        ),\n        resultSourceMap: snapshot.resultSourceMap,\n      }\n    }\n    return snapshot\n  }, [cache, documentsCacheLastUpdated, liveDocument, perspective, snapshot])\n}\n\nlet warnedAboutCrossDatasetReference = false\nexport function turboChargeResultIfSourceMap<T = unknown>(\n  cache: SharedProps['cache'],\n  liveDocument: Partial<SanityDocument> | null | undefined,\n  result: T,\n  perspective: ClientPerspective,\n  resultSourceMap?: ContentSourceMap,\n): T {\n  if (perspective === 'raw') {\n    throw new Error(\n      'turboChargeResultIfSourceMap does not support raw perspective',\n    )\n  }\n  return applySourceDocuments(\n    result,\n    resultSourceMap,\n    (sourceDocument) => {\n      if (sourceDocument._projectId) {\n        // @TODO Handle cross dataset references\n        if (!warnedAboutCrossDatasetReference) {\n          // eslint-disable-next-line no-console\n          console.warn(\n            'Cross dataset references are not supported yet, ignoring source document',\n            sourceDocument,\n          )\n          warnedAboutCrossDatasetReference = true\n        }\n        return undefined\n      }\n      // If there's a displayed document, always prefer it\n      if (\n        liveDocument?._id &&\n        getPublishedId(liveDocument._id) === getPublishedId(sourceDocument._id)\n      ) {\n        return liveDocument\n      }\n      // Fallback to general documents cache\n      return cache.get(sourceDocument._id)\n    },\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (changedValue: any, { previousValue }) => {\n      if (\n        typeof changedValue === 'number' &&\n        typeof previousValue === 'string'\n      ) {\n        // If the string() function was used in the query, we need to convert the source value to a string as well\n        return `${changedValue}`\n      }\n      return changedValue\n    },\n    perspective,\n  )\n}\n"],"names":["u","e","document","addEventListener","removeEventListener","Turbo","memo","props","cache","client","turboIds","setDocumentsCacheLastUpdated","batch","setBatch","useState","useEffect","batchSet","Set","flat","nextBatch","turboId","has","add","nextBatchSlice","slice","LIVE_QUERY_CACHE_BATCH_SIZE","length","prevBatch","subscription","listen","events","effectFormat","includePreviousRevision","includeResult","tag","subscribe","update","_a","_b","type","transition","delete","documentId","Date","now","effects","apply","cachedDocument","peek","patchDoc","_rev","patchedDocument","applyPatch","set","unsubscribe","jsx","Fragment","children","map","ids","GetDocuments","JSON","stringify","missingIds","filter","id","getDocuments","then","documents","doc","_id","console","error","QuerySubscription","projectId","dataset","perspective","query","refreshInterval","liveDocument","channel","documentsCacheLastUpdated","params","n","t","parse","useQueryParams","data","snapshot","setSnapshot","useMemo","config","setError","revalidate","startRefresh","o","s","i","navigator","onLine","window","r","visibilityState","d","c","f","setTimeout","clearTimeout","useRevalidate","shouldRefetch","fulfilled","fetching","controller","AbortController","async","effect","signal","result","resultSourceMap","fetch","filterResponse","aborted","onFinally","catch","name","finally","abort","turboChargeResultIfSourceMap","useQuerySubscription","send","displayName","warnedAboutCrossDatasetReference","Error","applySourceDocuments","sourceDocument","_projectId","getPublishedId","get","warn","changedValue","previousValue","concat","exports","default","activePerspective","liveQueries","documentsOnPage","LRUCache","LIVE_QUERY_CACHE_SIZE","studioClient","useClient","apiVersion","clientConfig","withConfig","documentsActuallyInUse","max","capacity","jsxs","Object","entries","key"],"mappings":"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"}