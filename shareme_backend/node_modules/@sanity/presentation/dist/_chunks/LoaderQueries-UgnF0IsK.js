import{jsxs as e,Fragment as t,jsx as n}from"react/jsx-runtime";import{applySourceDocuments as r,getPublishedId as o}from"@sanity/client/csm";import{useMemo as s,useState as c,useEffect as a,useSyncExternalStore as i,useCallback as u,memo as l}from"react";import{applyPatch as d}from"mendoza";import p from"mnemonist/lru-cache-with-delete";import{useClient as f}from"sanity";import{L as m,d as h}from"./index-ykAxZvMU.js";function v(e){return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)}function w(r){const{liveDocument:o,channel:i,perspective:u,liveQueries:l,documentsOnPage:d}=r,[h]=c((()=>new p(m))),v=f({apiVersion:"2023-10-16"}),w=s((()=>v.config()),[v]),g=s((()=>v.withConfig({resultSourceMap:"withKeyArraySelector"})),[v]);a((()=>{if(i){const{projectId:e,dataset:t}=w;i.send("loaders","loader/perspective",{projectId:e,dataset:t,perspective:u})}}),[i,w,u]);const L=s((()=>{const e=d.map((({_id:e})=>e)),t=[...new Set(e)],n=h.capacity;return t.length>=n&&(t.length=n),t}),[h.capacity,d]),[S,b]=c(0);return e(t,{children:[n(y,{cache:h,client:g,turboIds:L,setDocumentsCacheLastUpdated:b}),Object.entries(l).map((([e,{query:t,params:r,perspective:s}])=>n(I,{cache:h,projectId:w.projectId,dataset:w.dataset,perspective:s,query:t,params:r,channel:i,client:g,refreshInterval:u?2e3:0,liveDocument:o,documentsCacheLastUpdated:S},"".concat(e).concat(s))))]})}const y=l((function(e){const{cache:r,client:o,turboIds:s,setDocumentsCacheLastUpdated:i}=e,[u,l]=c([]);return a((()=>{const e=new Set(u.flat()),t=new Set;for(const n of s)e.has(n)||r.has(n)||t.add(n);const n=[...t].slice(0,h);0!==n.length&&l((e=>[...e.slice(-h),n]))}),[u,r,s]),a((()=>{const e=o.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe((e=>{var t,n;if("mutation"===e.type&&"disappear"===e.transition&&r.delete(e.documentId)&&i(Date.now()),"mutation"!==e.type||!(null==(n=null==(t=e.effects)?void 0:t.apply)?void 0:n.length))return;const o=r.peek(e.documentId);if(o){const t={...o};delete t._rev;const n=d(t,e.effects.apply);r.set(e.documentId,n),i(Date.now())}}));return()=>e.unsubscribe()}),[r,o,i]),n(t,{children:u.map((e=>n(g,{cache:r,client:o,ids:e,setDocumentsCacheLastUpdated:i},JSON.stringify(e))))})})),g=l((function(e){const{client:t,cache:n,ids:r,setDocumentsCacheLastUpdated:o}=e;return a((()=>{const e=r.filter((e=>!n.has(e)));0!==e.length&&t.getDocuments(e).then((e=>{for(const t of e)t&&(null==t?void 0:t._id)&&(n.set(t._id,t),o(Date.now()))}),console.error)}),[n,t,r,o]),null}));function I(e){const{cache:t,projectId:n,dataset:r,perspective:o,query:l,client:d,refreshInterval:p,liveDocument:f,channel:m,documentsCacheLastUpdated:h}=e,w=function(e){const t=s((()=>JSON.stringify(e||{})),[e]);return s((()=>JSON.parse(t)),[t])}(e.params),y=function(e){const{cache:t,liveDocument:n,client:r,refreshInterval:o,query:l,params:d,perspective:p,documentsCacheLastUpdated:f}=e,[m,h]=c(null),{projectId:w,dataset:y}=s((()=>{const{projectId:e,dataset:t}=r.config();return{projectId:e,dataset:t}}),[r]),[g,I]=c(null);if(g)throw g;const[L,b]=function(e){const{refreshInterval:t}=e,n=function(){const[e,t]=c(!1);a((()=>{t(navigator.onLine);const e=()=>t(!0),n=()=>t(!1);return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}}),[]);const n=i(v,(()=>document.visibilityState),(()=>"hidden"));return!e||"hidden"===n}(),[r,o]=c("hit"),s=u((()=>(o("inflight"),()=>o("hit"))),[]);return a((()=>{if(!t||"hit"!==r)return;const e=setTimeout((()=>o("stale")),t);return()=>clearTimeout(e)}),[t,r]),a((()=>{if("hit"!==r)return;const e=()=>o("stale");return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)}),[t,r]),a((()=>{n&&"hit"===r&&o("stale"),n||"stale"!==r||o("refresh")}),[n,r]),[r,s]}({refreshInterval:o}),D="refresh"===L||"inflight"===L;return a((()=>{if(!D)return;let e=!1,t=!1;const n=new AbortController;async function o(){const{signal:o}=n;t=!0;const{result:s,resultSourceMap:c}=await r.fetch(l,d,{tag:"presentation-loader",signal:o,perspective:p,filterResponse:!1});t=!1,o.aborted||(h({result:s,resultSourceMap:c}),e=!0)}const s=b();return o().catch((e=>{t=!1,"AbortError"!==e.name&&I(e)})).finally(s),()=>{e||t||n.abort()}}),[r,y,n,d,p,w,l,D,b]),s((()=>f&&(null==m?void 0:m.resultSourceMap)?{result:S(t,n,m.result,p,m.resultSourceMap),resultSourceMap:m.resultSourceMap}:m),[t,f,n,p,m])}({cache:t,client:d,liveDocument:f,params:w,perspective:o,query:l,refreshInterval:p,documentsCacheLastUpdated:h}),g=null==y?void 0:y.result,I=null==y?void 0:y.resultSourceMap;return a((()=>{I&&m.send("loaders","loader/query-change",{projectId:n,dataset:r,perspective:o,query:l,params:w,result:g,resultSourceMap:I})}),[m,r,w,o,n,l,g,I]),null}g.displayName="GetDocuments";let L=!1;function S(e,t,n,s,c){if("raw"===s)throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return r(n,c,(n=>{if(!n._projectId)return(null==t?void 0:t._id)&&o(t._id)===o(n._id)?t:e.get(n._id);L||(console.warn("Cross dataset references are not supported yet, ignoring source document",n),L=!0)}),((e,{previousValue:t})=>"number"==typeof e&&"string"==typeof t?"".concat(e):e),s)}export{w as default,S as turboChargeResultIfSourceMap};//# sourceMappingURL=LoaderQueries-UgnF0IsK.js.map
